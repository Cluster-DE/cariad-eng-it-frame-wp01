name: terraform plan
inputs:
  working-directory:
    required: true
outputs:
  tf-plan-string:
    value: ${{ steps.tf-plan-string.outputs.summary }}

runs:
  using: "composite"
  steps:
    - name: terraform plan
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      run: |
        export exitcode=0
        terraform plan -input=false -detailed-exitcode -no-color -out tfplan || export exitcode=$?
        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        
        if [ $exitcode -eq 1 ]; then
          echo Terraform Plan Failed!
          exit 1
        else 
          exit 0
        fi
    - name: terraform plan string
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      id: tf-plan-string
      run: |
        TERRAFORM_PLAN=$(terraform show -no-color tfplan)
        delimiter="$(openssl rand -hex 8)"
        echo "summary<<${delimiter}" >> $GITHUB_OUTPUT
        echo "## Check Terraform Plan" >> $GITHUB_OUTPUT
        echo "<details><summary>Click to expand</summary>" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo '```terraform' >> $GITHUB_OUTPUT
        echo "$TERRAFORM_PLAN" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "</details>" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT
